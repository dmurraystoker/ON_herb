---
title: "Urbanization influences communities of milkweed-specialist herbivorous insects"
subtitle: "ON_herb Figures"
author:
  - Lindsay S. Miles
  - Vanessa J. Nahn
  - David Murray-Stoker
  - Marc T. J. Johnson
output:
  pdf_document:
    toc: true
    toc_depth: 4
    fig_caption: yes
    latex_engine: xelatex
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(results = "hold", fig.pos = "H", fig.align = "center", out.width = "92.5%")
options(knitr.graphics.error = FALSE)
kableExtra::usepackage_latex("float")
```

```{r Load Package for R Markdown, include = FALSE}
library(kableExtra)
library(knitr)
```

```{r Load Packages & Data, echo = TRUE, results = "hide"}
## Load the tidyverse
library(tidyverse)

## Map
library(maps)
library(mapdata)
library(maptools)
library(ggmap)

## Figures
library(calecopal)
library(ggpubr)
library(grid)
library(gridExtra)
library(scales)

## Load the final workspace
load("data_analysis/1-analyses/ON_herb-analyses-workspace.RData")

## Read in site information
site.information  <- read_csv(
	"data/site_information.csv",
	col_types = c("fffnnnf"),
	show_col_types = FALSE
	)
```


# Colour Palette

```{r Set Colour Palette, echo = TRUE}
## Set colour palette (caleco | superbloom3)
superbloom.continuous <- cal_palette(name = "superbloom3", n = 20, type = "continuous")

## View the colour palette
show_col(superbloom.continuous) 

## Standard palette for the site map
superbloom.map <- superbloom.continuous[c(1, 5, 7, 9, 15, 20)]

## Standard palette for the 5 Cities
superbloom.5 <- superbloom.continuous[c(1, 5, 7, 9, 15)]

# Palette for connecting lines in the 5 cities
superbloom.10.lines <- c("#E69512", "#E69512", "#CB135E", "#CB135E", "#7B3478", "#7B3478",
												 "#3A5085", "#3A5085", "#464F63", "#464F63")
```


\newpage
# Site Map

```{r Get Site Map from Google, echo = TRUE, results = "hide"}
## Compute bounding box
ON_bbox <- make_bbox(lat = Latitude, lon = Longitude, data = site.information)

## Get map from google
ON_big <- get_map(location = ON_bbox, source = "google", maptype = "satellite")

## Plot points and colour by city
site.map <- ggmap(ON_big) + 
	geom_point(
		data = site.information, 
		mapping = aes(x = Longitude, y = Latitude, color = City, pch = Habitat)
		) +
	scale_colour_manual(values = superbloom.map, name = "City") +
	scale_shape_manual(values = c(17, 19),  name = "Habitat") +
	labs(x = "Longitude", y = "Latitude") +
	theme_pubr()
```

\vspace{10pt}

```{r View the Site Map Figure, echo = FALSE, fig.cap = "Basic site map figure."}
site.map 
```

\vspace{10pt}

```{r Export the Site Map, include = FALSE}
## Export the figure
ggsave("fig_1-site_map.jpg", 
			 plot = site.map,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```



\newpage
# Abundance, Richness, & Diversity | Toronto

```{r Set the Toronto ARD Figures, echo = TRUE}
## Abundance
toronto.abundance.figure <- ggscatter(
	data = toronto.herbivores,
	x = "Distance",
	y = "Summed_Abundance",
	color = "Season",
	xlab = "Distance",
	ylab = "Community Abundance",
	title = "(A) Abundance",
	ggtheme = theme_pubr(),
	legend = "right",
	add = "reg.line",
	conf.int = TRUE
)

## Richness
toronto.richness.figure <- ggscatter(
	data = toronto.herbivores,
	x = "Distance",
	y = "Richness",
	color = "Season",
	xlab = "Distance",
	ylab = "Species Richness",
	title = "(B) Richness",
	ggtheme = theme_pubr(),
	legend = "right",
	add = "reg.line",
	conf.int = TRUE
)

## Diversity
toronto.diversity.figure <- ggscatter(
	data = toronto.herbivores,
	x = "Distance",
	y = "Diversity",
	color = "Season",
	xlab = "Distance",
	ylab = "Diversity",
	title = "(C) Diversity",
	ggtheme = theme_pubr(),
	legend = "right",
	add = "reg.line",
	conf.int = TRUE
)
```

\vspace{10pt}

```{r Arrange the Toronto ARD Panel Figure, echo = TRUE}
## Arrange the panel figure
toronto.ARD.figure <- ggarrange(
	toronto.abundance.figure, toronto.richness.figure, toronto.diversity.figure,
	nrow = 3,
	ncol = 1,
	align = "v",
	legend = "top",
	common.legend = TRUE
)
```

\vspace{10pt}

```{r Export the Toronto ARD Figure, echo = TRUE}
## Export the figure
ggsave("fig_2-toronto_ARD.jpg", 
			 plot = toronto.ARD.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 7.5,
			 height = 10,
			 units = "in",
			 dpi = 900)
```




\newpage
# Abundance, Richness, & Diversity | 5 Cities

```{r Set the 5 Cities ARD Figures, echo = TRUE}
## Abundance
five.cities.abundance.figure <- ggerrorplot(
	data = five.cities.herbivores,
	x = "Habitat",
	y = "Summed_Abundance",
	desc_stat = "mean_se",
	color = "City",
	xlab = "Habitat",
	ylab = "Community Abundance",
	title = "(A) Abundance",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path")

## Richness
five.cities.richness.figure <- ggerrorplot(
	data = five.cities.herbivores,
	x = "Habitat",
	y = "Richness",
	desc_stat = "mean_se",
	color = "City",
	xlab = "Habitat",
	ylab = "Richness",
	title = "(B) Richness",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path")

## Diversity
five.cities.diversity.figure <- ggerrorplot(
	data = five.cities.herbivores,
	x = "Habitat",
	y = "Diversity",
	desc_stat = "mean_se",
	color = "City",
	xlab = "Habitat",
	ylab = "Diversity",
	title = "(C) Diversity",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path")
```

\vspace{10pt}

```{r Arrange the 5 Cities ARD Panel Figure, echo = TRUE}
## Arrange the panel figure
five.cities.ARD.figure <- ggarrange(
	five.cities.abundance.figure, five.cities.richness.figure, five.cities.diversity.figure,
	nrow = 3,
	ncol = 1,
	align = "v",
	legend = "top",
	common.legend = TRUE
)
```

\vspace{10pt}

```{r Export the 5 Cities ARD Figure, echo = TRUE}
## Export the figure
ggsave("fig_3-five.cities_ARD.jpg", 
			 plot = five.cities.ARD.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 7.5,
			 height = 10,
			 units = "in",
			 dpi = 900)
```




\newpage
# Leaf Herbivory | Toronto

```{r Set the Toronto Leaf Herbivory Figure, echo = TRUE}
toronto.leaf.herbivory.figure <- ggscatter(
	data = toronto.leaf.damage,
	x = "Distance",
	y = "Mean_Leaf_Herbivory",
	color = "Season",
	xlab = "Distance",
	ylab = "Mean Leaf Herbivory (%)",
	ggtheme = theme_pubr(),
	legend = "right",
	add = "reg.line",
	conf.int = TRUE
)
```

\vspace{10pt}

```{r Export the Toronto Leaf Herbivory Figure, echo = TRUE}
## Export the figure
ggsave("fig_4-toronto_leaf_herbivory.jpg", 
			 plot = toronto.leaf.herbivory.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```




\newpage
# Leaf Herbivory | 5 Cities

```{r Set the 5 Cities Leaf Herbivory Figure, echo = TRUE}
five.cities.leaf.herbivory.figure <- ggerrorplot(
	data = five.cities.leaf.damage,
	x = "Habitat",
	y = "Mean_Leaf_Herbivory",
	desc_stat = "mean_se",
	color = "City",
	xlab = "Habitat",
	ylab = "Mean Leaf Herbivory (%)",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path")
```

\vspace{10pt}

```{r Export the 5 Cities Leaf Herbivory Figure, echo = TRUE}
## Export the figure
ggsave("fig_5-five.cities_leaf_herbivory.jpg", 
			 plot = five.cities.leaf.herbivory.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```




\newpage
# Community Composition | Toronto

```{r Toronto Community Composition Figure: Data Management, echo = TRUE}
toronto.herbivore.abundances.wide <- toronto.herbivores %>%
	select(Population, Distance, Season) %>%
	bind_cols(toronto.community.matrix)

toronto.herbivore.abundances.long <- toronto.herbivore.abundances.wide %>%
	gather(Herbivore_Species, Measurement, Danaus:Liriomyza, factor_key = TRUE)
```

\vspace{10pt}

```{r Set the Toronto Herbivore Abundances Figure, echo = TRUE}
toronto.herbivore.abundances.figure <- ggscatter(
	data = toronto.herbivore.abundances.long,
	x = "Distance",
	y = "Measurement",
	color = "Herbivore_Species",
	xlab = "Distance",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr(),
	add = "reg.line",
	conf.int = TRUE
) %>%
	facet(
		facet.by = "Season",
		nrow = 1,
		ncol = 2
	)
```

\vspace{10pt}

```{r Export the Toronto Herbivore Abundances Figure, echo = TRUE}
## Export the figure
ggsave("fig_6-toronto_herbivore_abundances.jpg", 
			 plot = toronto.herbivore.abundances.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```




\newpage
# Community Composition | 5 Cities

## Herbivores (No Aphids)

```{r 5 Cities Community Composition Figure: Data Management, echo = TRUE}
five.cities.herbivore.abundances.wide <- five.cities.herbivores %>%
	select(City, Habitat, Season) %>%
	bind_cols(five.cities.community.matrix)

five.cities.herbivore.abundances.long.no.aphids <- five.cities.herbivore.abundances.wide %>%
	gather(Herbivore_Species, Measurement, Danaus:Liriomyza, factor_key = TRUE) %>%
	filter(Herbivore_Species != "Aphis_spp")

five.cities.herbivore.abundances.long.aphids <- five.cities.herbivore.abundances.wide %>%
	gather(Herbivore_Species, Measurement, Aphis_spp, factor_key = TRUE)
```

\vspace{10pt}

```{r Set the 5 Cities Herbivore Abundances (No Aphids) Figure, echo = TRUE}
five.cities.herbivore.abundances.no.aphids.figure <- ggerrorplot(
	data = five.cities.herbivore.abundances.long.no.aphids,
	x = "Habitat",
	y = "Measurement",
	desc_stat = "mean_se",
	color = "Herbivore_Species",
	xlab = "Habitat",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	)
```

\vspace{10pt}

```{r Export the 5 Cities Herbivore Abundances (No Aphids) Figure, echo = TRUE}
## Export the figure
ggsave("fig_7a-five.cities_herbivore_abundances_no_aphids.jpg", 
			 plot = five.cities.herbivore.abundances.no.aphids.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 10,
			 height = 7.5,
			 units = "in",
			 dpi = 900)
```


## Aphids

```{r Set the 5 Cities Herbivore Abundances (Aphids) Figure, echo = TRUE}
five.cities.herbivore.abundances.aphids.figure <- ggerrorplot(
	data = five.cities.herbivore.abundances.long.aphids,
	x = "Habitat",
	y = "Measurement",
	desc_stat = "mean_se",
	color = "Herbivore_Species",
	xlab = "Habitat",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	)
```

\vspace{10pt}

```{r Export the 5 Cities Herbivore Abundances (Aphids) Figure, echo = TRUE}
## Export the figure
ggsave("fig_7b-five.cities_herbivore_abundances_aphids.jpg", 
			 plot = five.cities.herbivore.abundances.aphids.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```



\newpage
# Dispersal Traits | Toronto

```{r Toronto Dispersal Traits Figure: Data Management, echo = TRUE}
toronto.dispersal.traits.wide <- toronto.herbivores %>%
	select(Population, Distance, Season) %>%
	bind_cols(toronto.trait.abundances)

toronto.dispersal.traits.long <- toronto.dispersal.traits.wide %>%
	gather(Dispersal_Trait, Measurement, X1000_km:X1.2_km, factor_key = TRUE)
```

\vspace{10pt}

```{r Set the Toronto Dispersal Traits Figure, echo = TRUE}
toronto.dispersal.traits.figure <- ggscatter(
	data = toronto.dispersal.traits.long,
	x = "Distance",
	y = "Measurement",
	color = "Dispersal_Trait",
	xlab = "Distance",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr(),
	add = "reg.line",
	conf.int = TRUE
) %>%
	facet(
		facet.by = "Season",
		nrow = 1,
		ncol = 2
	)
```

\vspace{10pt}

```{r Export the Toronto Dispersal Traits Figure, echo = TRUE}
## Export the figure
ggsave("fig_8-toronto_dispersal_traits.jpg", 
			 plot = toronto.dispersal.traits.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```




\newpage
# Dispersal Traits | 5 Cities

## Herbivores (No Aphids)

```{r 5 Cities Dispersal Traits Figure: Data Management, echo = TRUE}
five.cities.dispersal.traits.wide <- five.cities.herbivores %>%
	select(City, Habitat, Season) %>%
	bind_cols(five.cities.trait.abundances)

five.cities.dispersal.traits.long.no.aphids <- five.cities.dispersal.traits.wide  %>%
	gather(Dispersal_Trait, Measurement, X1000_km:X1.2_km, factor_key = TRUE) %>%
	filter(Dispersal_Trait != "X100_km")

five.cities.dispersal.traits.long.aphids <- five.cities.dispersal.traits.wide  %>%
	gather(Dispersal_Trait, Measurement, X1000_km:X1.2_km, factor_key = TRUE) %>%
	filter(Dispersal_Trait == "X100_km")
```

\vspace{10pt}

```{r Set the 5 Cities Dispersal Traits (No Aphids) Figure, echo = TRUE}
five.cities.dispersal.traits.no.aphids.figure <- ggerrorplot(
	data = five.cities.dispersal.traits.long.no.aphids,
	x = "Habitat",
	y = "Measurement",
	desc_stat = "mean_se",
	color = "Dispersal_Trait",
	xlab = "Habitat",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	)
```

\vspace{10pt}

```{r Export the 5 Cities Dispersal Traits (No Aphids) Figure, echo = TRUE}
## Export the figure
ggsave("fig_9a-five.cities_dispersal_traits_no_aphids.jpg", 
			 plot = five.cities.dispersal.traits.no.aphids.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 10,
			 height = 7.5,
			 units = "in",
			 dpi = 900)
```


## Aphids

```{r Set the 5 Cities Dispersal Traits (Aphids) Figure, echo = TRUE}
five.cities.dispersal.traits.aphids.figure <- ggerrorplot(
	data = five.cities.dispersal.traits.long.aphids,
	x = "Habitat",
	y = "Measurement",
	desc_stat = "mean_se",
	color = "Dispersal_Trait",
	xlab = "Habitat",
	ylab = "Herbivore Abundance",
	ggtheme = theme_pubr()
	) %>%
	facet(
		facet.by = c("Season", "City"),
		nrow = 1,
		ncol = 5
	)
```

\vspace{10pt}

```{r Export the 5 Cities Dispersal Traits (Aphids) Figure, echo = TRUE}
## Export the figure
ggsave("fig_9b-five.cities_dispersal_traits_aphids.jpg", 
			 plot = five.cities.dispersal.traits.aphids.figure,
			 device = "jpg",
			 path = "figures/basic_figures/",
			 width = 8,
			 height = 6,
			 units = "in",
			 dpi = 900)
```



\newpage
# R Session Information

```{r R Packages, echo = FALSE}
df_session_packages <- devtools::session_info()$packages %>% 
  as.data.frame(.) %>% 
  filter(attached == TRUE) %>% 
  dplyr::select(loadedversion, date) %>% 
  rownames_to_column

colnames(df_session_packages) <- c("Package", "Loaded Version", "Date")

kable(
  df_session_packages, 
  booktabs = TRUE,
  caption = "Packages required for data management and figure creation."
  ) %>%
	kable_styling(
		full_width = FALSE,
  	latex_options = c("HOLD_position", "striped")
  	) 
```





