---
title: "Urbanization influences communities of milkweed-specialist herbivorous insects"
subtitle: "ON_herb"
author:
  - Lindsay S. Miles
  - Vanessa J. Nahn
  - David Murray-Stoker
  - Marc T. J. Johnson
output: 
  pdf_document: 
    latex_engine: xelatex
    fig_caption: yes
    toc_depth: 4
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.graphics.error = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(results = "hold")
knitr::opts_chunk$set(fig.pos = "H")
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(out.width = "85%")
kableExtra::usepackage_latex("float")
```

```{r Load Package for RMarkdown, include = FALSE}
library(kableExtra)
library(knitr)
```

```{r Load Packages & Data, echo = FALSE}
library(ade4)
library(broom)
library(car)
library(DHARMa)
library(emmeans)
library(ggpubr)
library(glmmTMB)
library(gvlma)
library(Hmisc)
library(lattice)
library(lme4)
library(lmerTest)
library(MASS)
library(Matrix)
library(piecewiseSEM)
library(Rmisc)

## Map
library(maps)
library(mapdata)
library(maptools)
library(ggmap)

## Figures
library(calecopal)
library(ggpubr)
library(grid)
library(gridExtra)
library(scales)

## Load plyr before the tidyverse (avoids potential errors)
library(plyr)

## Load the tidyverse
library(tidyverse)

## Load data
early.5.cities             <- read.csv("data/ON_herb-early_5_cities.csv", header = TRUE)
late.5.cities              <- read.csv("data/ON_herb-late_5_cities.csv", header = TRUE)
early.toronto              <- read.csv("data/ON_herb-early_toronto.csv", header = TRUE)
late.toronto               <- read.csv("data/ON_herb-late_toronto.csv", header = TRUE)
early.5.cities.n.aphid     <- read.csv("data/ON_herb-early_5_cities-no_aphids.csv", header = TRUE)
late.5.cities.n.aphid      <- read.csv("data/ON_herb-late_5_cities-no_aphids.csv", header = TRUE)
early.toronto.n.aphid      <- read.csv("data/ON_herb-early_toronto-no_aphids.csv", header = TRUE)
late.toronto.n.aphid       <- read.csv("data/ON_herb-late_toronto-no_aphids.csv", header = TRUE)
site.locations             <- read.csv("data/ON_herb-coordinates.csv", header = TRUE)
raw.SEM.data               <- read_csv("data/ON_herb-SEM.csv")
```

```{r Colour Palettes for Figures, include = FALSE}
## Set colour palette (caleco | superbloom3)
superbloom.continuous <- cal_palette(name = "superbloom3", n = 20, type = "continuous")
show_col(superbloom.continuous)

## Standard palette for the site map
superbloom.map <- superbloom.continuous[c(1, 5, 7, 9, 15, 20)]

## Standard palette for the 5 Cities
superbloom.5 <- superbloom.continuous[c(1, 5, 7, 9, 15)]

# Palette for connecting lines in the 5 cities
superbloom.10.lines <- c("#E69512", "#E69512", "#CB135E", "#CB135E", "#7B3478", "#7B3478",
												 "#3A5085", "#3A5085", "#464F63", "#464F63")
```

# Research Question

We tested the hypothesis that urbanization disrupts specialized plant-herbivore species interactions, and these effects vary according to the characteristics of both cities and features of the individual organisms.


# Sampling Map

```{r Sampling Map, include = FALSE}
## Compute bounding box
ON_bbox <- make_bbox(lat = Lat, lon = Long, data = site.locations)

## Get map from google
ON_big <- get_map(location = ON_bbox, source = "google", maptype = "satellite")

## Plot points and colour by city
site.map <- ggmap(ON_big) + 
	geom_point(data = site.locations, 
						 mapping = aes(x = Long, y = Lat, color = City, pch = Type)) +
	scale_colour_manual(values = superbloom.map, name = "City") +
	scale_shape_manual(values = c(17, 19),  name = "Habitat") +
	labs(x = "Longitude", y = "Latitude") +
	theme_pubr()
```

```{r Site Map, echo = FALSE, fig.align = "center", fig.cap = "Map of sampling locations, with sites coloured by city. Urban sites are indicated by circles and rural sites by triangles. Toronto was sampled along an urbanization gradient while the 5 Cities were sampled using urban-rural pairs."}
site.map
```




\newpage
# Diversity Analyses

We analyzed the effects of urbanization on species diversity (measured as species richness) using generalized linear mixed models. Diversity models for the Toronto dataset were fitted to a Poisson error distribution with a correction for zero inflation using `glmmTMB()` with the following formula: 

$$ Diversity = Intercept + Distance + (1\ |\ Population) + e$$

where diversity was compared against distance from city center, with population fitted as a random effect and $e$ indicating the residual error. Diversity models for the 5 Cities dataset were fitted to a Poisson error distribution using `glmer()` with the following formula:

$$ Diversity = Intercept + Habitat + City + Habitat:City + (1\ |\ Population) + e$$

where diversity was compared against the main effects of habitat and city and their interaction, with population fitted as a random effect and $e$ indicating the residual error. For all diversity models across the Toronto and 5 Cities datasets, significance of fixed effects was estimated with Type II sums-of-squares implemented using the `Anova()` function in `car`.

\newpage
## Early Season Diversity, Toronto

```{r Early Season Diversity GLMM-Toronto, include = FALSE}
# Fit the model
pop.diversity.early.toronto <- glmmTMB(Diversity ~ Distance + (1 | Pop),
																			 data = early.toronto, 
																			 ziformula = ~1,
																			 family = poisson
																			 )
```

```{r Early Season Diversity GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.diversity.early.toronto.DHARMa <- simulateResiduals(
	pop.diversity.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Diversity Analyses-Toronto ANOVA, echo = FALSE, warning = FALSE}
kable(tidy(Anova(pop.diversity.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season diversity model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Diversity Toronto Plot, echo = FALSE, fig.cap = "Plot of diversity against distance from city center for the early season in Toronto."}
## Plot of diversity by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Diversity)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Diversity") +
	ggtitle("Diversity, Early Toronto") +
	theme_pubr()
```

\newpage
## Early Season Diversity, 5 Cities

```{r Early Season Diversity GLMM-5 Cities, include = FALSE}
# Fit the model
pop.diversity.early.5.cities <- glmer(Diversity ~ Habitat + City + Habitat:City + (1 | Pop),
																			data = early.5.cities,
																			family = poisson
																			)
```

```{r Early Season Diversity GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.diversity.early.5.cities.DHARMa <- simulateResiduals(
	pop.diversity.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Diversity Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.diversity.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season diversity model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Diversity 5 Cities Plot, echo = FALSE, fig.cap = "Plot of diversity by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of diversity by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Diversity",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = superbloom.5,
	xlab = "Habitat",
	ylab = "Diversity",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Diversity, Early 5 Cities")
```

\newpage
## Late Season Diversity, Toronto

```{r Late Season Diversity GLMM-Toronto, include = FALSE}
# Fit the model
pop.diversity.late.toronto <- glmmTMB(Diversity ~ Distance + (1 | Pop),
																			data = late.toronto, 
																			ziformula = ~1,
																			family = poisson
																			)
```

```{r Late Season Diversity GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.diversity.late.toronto.DHARMa <- simulateResiduals(
	pop.diversity.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Diversity Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.diversity.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season diversity model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
									 "chi-squared",
									 "df",
									 "P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Diversity Toronto Plot, echo = FALSE, fig.cap = "Plot of diversity against distance from city center for the late season in Toronto."}
## Plot of diversity by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Diversity)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Diversity") +
	ggtitle("Diversity, Late Toronto") +
	theme_pubr()
```

\newpage
## Late Season Diversity, 5 Cities

```{r Late Season Diversity GLMM-5 Cities, include = FALSE}
# Fit the model
pop.diversity.late.5.cities <- glmer(Diversity ~ Habitat + City + Habitat:City + (1 | Pop),
																		 data = late.5.cities,
																		 family = poisson
																		 )
```

```{r Late Season Diversity GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.diversity.late.5.cities.DHARMa <- simulateResiduals(
	pop.diversity.late.5.cities, n = 500, plot = TRUE
	)
```

```{r Late Season Diversity Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.diversity.late.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season diversity model for for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Diversity Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Initial check of the interaction term
pop.diversity.late.5.cities.emm_check <- emmip(
	pop.diversity.late.5.cities, 
	City ~ Habitat
	)
pop.diversity.late.5.cities.emm_check # Interaction is valid

## Calculate pairwise comparisons
pop.diversity.late.5.cities.emm <- emmeans(
	pop.diversity.late.5.cities,
	pairwise ~ City | Habitat
	)
```

```{r Late Season Diversity Analyses-5 Cities Post Hoc Comparisons, echo = FALSE}
kable(tidy(pop.diversity.late.5.cities.emm$contrasts),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the interaction between city and habitat for diversity for the late season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Diversity 5 Cities Plot, echo = FALSE, fig.cap = "Plot of diversity by habitat and city for the late season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of diversity by habitat and city in the late season for the 5 Cities
ggerrorplot(
	data = late.5.cities,
	x = "Habitat", y = "Diversity",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Diversity",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) +
	ggtitle("Diversity, Late 5 Cities")
```




\newpage
# Abundance Analyses

We analyzed the effects of urbanization on community abundance using generalized linear mixed models. Models for the both the Toronto and 5 Cities datasets were fitted to a Poisson error distribution with a correction for zero inflation using `glmmTMB()`. Models for the Toronto dataset were fitted to the following formula: 

$$ Abundance = Intercept + Distance + (1\ |\ Population) + e$$

where abundance was compared against distance from city center, with population fitted as a random effect and $e$ indicating the residual error. Diversity models for the 5 Cities dataset were fitted to the following formula:

$$ Abundance = Intercept + Habitat + City + Habitat:City + (1\ |\ Population) + e$$

where abundance was compared against the main effects of habitat and city and their interaction, with population fitted as a random effect and $e$ indicating the residual error. Aphids were removed from these analyses as they presented major outliers to the data because, when present, their abundance ranged from 10-1000. Aphids were analyzed in herbivore-specific models (see below). For all abundance models across the Toronto and 5 Cities datasets, significance of fixed effects was estimated with Type II sums-of-squares implemented using the `Anova()` function in `car`.

\newpage
## Early Season Abundance, Toronto

```{r Early Season Abundance Analyses-Toronto, include = FALSE}
pop.abundance.early.toronto <- glmmTMB(Abundance ~ Distance + (1 | Pop),
																			 data = early.toronto.n.aphid,
																			 ziformula = ~1,
																			 family = poisson()
																			 )
```

```{r Early Season Abundance GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.abundance.early.toronto.DHARMa <- simulateResiduals(
	pop.abundance.early.toronto, n = 500, plot = TRUE
	)

## Visual assessment
plot(pop.abundance.early.toronto.DHARMa) # Good model fit
```

```{r Early Season Abundance Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.abundance.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season abundance model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Abundance Toronto Plot, echo = FALSE, fig.cap = "Plot of abundance against distance from city center for the early season in Toronto."}
## Plot of abundance by distance in the early season for Toronto
ggplot(
	data = early.toronto.n.aphid,
	aes(x = Distance, y = Abundance)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Abundance, Early Toronto") +
	theme_pubr()
```

\newpage
## Early Season Abundance, 5 Cities

```{r Early Season Abundance Analyses-5 Cities, include = FALSE}
pop.abundance.early.5.cities <- glmmTMB(Abundance ~ Habitat + City + Habitat:City + (1 | Pop),
																				data = early.5.cities.n.aphid,
																				ziformula = ~1, 
																				family = poisson
																				)
```

```{r Early Season Abundance GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.abundance.early.5.cities.DHARMa <- simulateResiduals(
	pop.abundance.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Abundance Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.abundance.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season abundance model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Abundance Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Calculate main effect comparison for city
pop.abundance.early.5.cities.emm_city <- emmeans(
	pop.abundance.early.5.cities, "City"
	)

## Calculate main effect comparison for habitat
pop.abundance.early.5.cities.emm_habitat <- emmeans(
	pop.abundance.early.5.cities, "Habitat"
	)
```

```{r Early Season Abundance Analyses-5 Cities Post Hoc Comparisons (City), echo = FALSE}
kable(tidy(pop.abundance.early.5.cities.emm_city),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the main effect of city for abundance for the early season 5 Cities.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Abundance Analyses-5 Cities Post Hoc Comparisons (Habitat), echo = FALSE}
kable(tidy(pop.abundance.early.5.cities.emm_habitat),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the main effect of habitat for abundance for the early season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Abundance 5 Cities Plot, echo = FALSE, fig.cap = "Plot of abundance by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of abundance by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities.n.aphid,
	x = "Habitat", y = "Abundance",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) +
	ggtitle("Abundance, Early 5 Cities")
```

\newpage
## Late Season Abundance, Toronto

```{r Late Season Abundance Analyses-Toronto, include = FALSE}
pop.abundance.late.toronto <- glmmTMB(Abundance ~ Distance + (1 | Pop),
																			data = late.toronto.n.aphid,
																			ziformula = ~1,
																			family = poisson()
																			)
```

```{r Late Season Abundance GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.abundance.late.toronto.DHARMa <- simulateResiduals(
	pop.abundance.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Abundance Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.abundance.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season abundance model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Abundance Toronto Plot, echo = FALSE, fig.cap = "Plot of abundance against distance from city center for the late season in Toronto."}
## Plot of abundance by distance in the late season for Toronto
ggplot(
	data = late.toronto.n.aphid,
	aes(x = Distance, y = Abundance)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Abundance, Late Toronto") +
	theme_pubr()
```

\newpage
## Late Season Abundance, 5 Cities

```{r Late Season Abundance Analyses-5 Cities, include = FALSE}
pop.abundance.late.5.cities <- glmmTMB(Abundance ~ Habitat + City + Habitat:City + (1 | Pop),
																			 data = late.5.cities.n.aphid,
																			 ziformula = ~1, 
																			 family = poisson
																			 )
```

```{r Late Season Abundance GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.abundance.late.5.cities.DHARMa <- simulateResiduals(
	pop.abundance.late.5.cities, n = 500, plot = TRUE
	)
```

```{r Late Season Abundance Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.abundance.late.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season abundance model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Abundance Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Initial check of the interaction term
pop.abundance.late.5.cities.emm_check <- emmip(
	pop.abundance.late.5.cities, 
	City ~ Habitat
	)
pop.abundance.late.5.cities.emm_check # Interaction is valid

## Calculate pairwise comparisons
pop.abundance.late.5.cities.emm <- emmeans(
	pop.abundance.late.5.cities,
	pairwise ~ City | Habitat)
```

```{r Late Season Abundance Analyses-5 Cities Post Hoc Comparisons, echo = FALSE}
kable(tidy(pop.abundance.late.5.cities.emm$contrasts),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the interaction between city and habitat for abundance for the late season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Abundance 5 Cities Plot, echo = FALSE, fig.cap = "Plot of abundance by habitat and city for the late season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of abundance by habitat and city in the late season for the 5 Cities
ggerrorplot(
	data = late.5.cities.n.aphid,
	x = "Habitat", y = "Abundance",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) +
	ggtitle("Abundance, Late 5 Cities")
```




\newpage
# Leaf Herbivory

We analyzed the effects of urbanization on average leaf herbivory using linear mixed models.Models for the Toronto and 5 Cities datasets were fitted using `lmer()`. Average leaf herbivory was square-root transformed to better meet model assumptions. Models for the Toronto dataset were fitted to the following formula: 

$$ Average\ Leaf\ Herbivory\ = Intercept + Distance + (1\ |\ Population) + e$$

where average leaf herbivory was compared against distance from city center, with population fitted as a random effect and $e$ indicating the residual error. Diversity models for the 5 Cities dataset were fitted to the following formula:

$$ Average\ Leaf\ Herbivory\ = Intercept + Habitat + City + Habitat:City + (1\ |\ Population) + e$$

where average leaf herbivory was compared against the main effects of habitat and city and their interaction, with population fitted as a random effect and $e$ indicating the residual error. For all average leaf herbivory models across the Toronto and 5 Cities datasets, significance of fixed effects was estimated with Type II sums-of-squares implemented using the `Anova()` function in `car`.

\newpage
## Early Season Leaf Herbivory, Toronto

```{r Early Season Leaf Herbivory LMM-Toronto, include = FALSE}
pop.avg.herbivory.early.toronto <- lmer(
	sqrt(Average_Leaf_Herbivory) ~ Distance + (1 | Pop),
	data = early.toronto
	)
```

```{r Early Season Leaf Herbivory LMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.avg.herbivory.early.toronto.DHARMa <- simulateResiduals(
	pop.avg.herbivory.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Leaf Herbivory Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.avg.herbivory.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season leaf herbivory model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Leaf Herbivory Toronto Plot, echo = FALSE, fig.cap = "Plot of average leaf herbivory against distance from city center for the early season in Toronto."}
## Plot of diversity by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Average_Leaf_Herbivory)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "lm", formula = y ~ x, se = TRUE,
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Average Leaf Herbivory") +
	ggtitle("Average Leaf Herbivory, Early Toronto") +
	theme_pubr()
```

\newpage
## Early Season Leaf Herbivory, 5 Cities

```{r Early Season Leaf Herbivory LMM-5 Cities, include = FALSE}
pop.avg.herbivory.early.5.cities <- lmer(
	sqrt(Average_Leaf_Herbivory) ~ Habitat + City + Habitat:City + (1 | Pop),
	data = early.5.cities
	)
```

```{r Early Season Leaf Herbivory LMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.avg.herbivory.early.5.cities.DHARMa <- simulateResiduals(
	pop.avg.herbivory.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Leaf Herbivory Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.avg.herbivory.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season leaf herbivory model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Leaf Herbivory Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Initial check of the interaction term
pop.avg.herbivory.early.5.cities.emm_check <- emmip(
	pop.avg.herbivory.early.5.cities, 
	City ~ Habitat
	)
pop.avg.herbivory.early.5.cities.emm_check # Interaction is valid

## Calculate pairwise comparisons
pop.avg.herbivory.early.5.cities.emm <- emmeans(
	pop.avg.herbivory.early.5.cities,
	pairwise ~ City | Habitat)
```

```{r Early Season Leaf Herbivory Analyses-5 Cities Post Hoc Comparisons, echo = FALSE}
kable(tidy(pop.avg.herbivory.early.5.cities.emm$contrasts),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the interaction between city and habitat for leaf herbivory for the early season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Leaf Herivory 5 Cities Plot, echo = FALSE, fig.cap = "Plot of average leaf herbivory by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of leaf herbivory by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Average_Leaf_Herbivory",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Average Leaf Herbivory",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) +
	ggtitle("Average Leaf Herbivory, Early 5 Cities")
```

\newpage
## Late Season Leaf Herbivory, Toronto

```{r Late Season Leaf Herbivory LMM-Toronto, include = FALSE}
pop.avg.herbivory.late.toronto <- lmer(
	sqrt(Average_Leaf_Herbivory) ~ Distance + (1 | Pop),
	data = late.toronto
	)
```

```{r Late Season Leaf Herbivory LMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.avg.herbivory.late.toronto.DHARMa <- simulateResiduals(
	pop.avg.herbivory.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Leaf Herbivory Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.avg.herbivory.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season leaf herbivory model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Leaf Herbivory Toronto Plot, echo = FALSE, fig.cap = "Plot of average leaf herbivory against distance from city center for the late season in Toronto."}
## Plot of diversity by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Average_Leaf_Herbivory)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "lm", formula = y ~ x, se = TRUE,
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Average Leaf Herbivory") +
	ggtitle("Average Leaf Herbivory, Late Toronto") +
	theme_pubr()
```

\newpage
## Late Season Leaf Herbivory, 5 Cities

```{r Late Season Leaf Herbivory LMM-5 Cities, include = FALSE}
pop.avg.herbivory.late.5.cities <- lmer(
	sqrt(Average_Leaf_Herbivory) ~ Habitat + City + Habitat:City + (1 | Pop),
	data = late.5.cities
	)
```

```{r Late Season Leaf Herbivory LMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.avg.herbivory.late.5.cities.DHARMa <- simulateResiduals(
	pop.avg.herbivory.late.5.cities, n = 500, plot = TRUE
	)
```

```{r Late Season Leaf Herbivory Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.avg.herbivory.late.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season leaf herbivory model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Leaf Herbivory Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Calculate main effect comparison for habitat
pop.avg.herbivory.late.5.cities.emm_habitat <- emmeans(
	pop.avg.herbivory.late.5.cities, "Habitat"
	)
```

```{r Late Season Leaf Herbivory Analyses-5 Cities Post Hoc Comparisons (Habitat), echo = FALSE, results = "hold", warning = FALSE}
kable(tidy(pop.avg.herbivory.late.5.cities.emm_habitat),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the main effect of habitat for leaf herbivory for the late season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Leaf Herivory 5 Cities Plot, echo = FALSE, fig.cap = "Plot of average leaf herbivory by habitat and city for the late season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of leaf herbivory by habitat and city in the late season for the 5 Cities
ggerrorplot(
	data = late.5.cities,
	x = "Habitat", y = "Average_Leaf_Herbivory",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Average Leaf Herbivory",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) +
	ggtitle("Average Leaf Herbivory, Late 5 Cities")
```




\newpage
# Herbivore-Specific Models
We analyzed the effects of urbanization on herbivore species abundance using generalized linear mixed models. We focused on the abundances for *Danaus*, *Rhysomatus*, *Aphis*, and *Tetraopes*.

Models for the both the Toronto and 5 Cities datasets were fitted to a Poisson error distribution, but the Toronto models were fitted with a correction for zero inflation using `glmmTMB()` while the 5 Cities models were fitted using `glmer()`. Models for the Toronto dataset were fitted to the following formula: 

$$ Abundance_{i} = Intercept + Distance + (1\ |\ Population) + e_{i}$$

where abundance was compared against distance from city center, with population fitted as a random effect and $e$ indicating the residual error. The subscript $i$ indicates the same model structure was fitted for each of the focal herbivore species.

Diversity models for the 5 Cities dataset were fitted to the following formula:

$$ Abundance_{i} = Intercept + Habitat + City + Habitat:City + (1\ |\ Population) + e_{i}$$

where abundance was compared against the main effects of habitat and city and their interaction, with population fitted as a random effect and $e$ indicating the residual error. As with the Toronto dataset, the subscript $i$ indicates the same model structure was fitted for each of the focal herbivore species. For all abundance models across the Toronto and 5 Cities datasets, significance of fixed effects was estimated with Type II sums-of-squares implemented using the `Anova()` function in `car`.

\newpage
## Danaus

### Early Season Danaus, Toronto

```{r Early Season Danaus GLMM-Toronto, include = FALSE}
# Fit the model
pop.danaus.early.toronto <- glmmTMB(Monarchs ~ Distance + (1 | Pop),
																		data = early.toronto,
																		ziformula = ~1,
																		family = poisson
																		)
```

```{r Early Season Danaus GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.danaus.early.toronto.DHARMa <- simulateResiduals(
	pop.danaus.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Danaus Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.danaus.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Danaus model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Danaus Toronto Plot, echo = FALSE, fig.cap = "Plot of Danaus abundance against distance from city center for the early season in Toronto."}
## Plot of Danaus by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Monarchs)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Danaus, Early Toronto") +
	theme_pubr()
```

\newpage
### Early Season Danaus, 5 Cities

```{r Early Season Danaus GLMM-5 Cities, include = FALSE}
# Fit the model
pop.danaus.early.5.cities <- glmer(Monarchs ~ Habitat + City + Habitat:City + (1 | Pop),
																	 data = early.5.cities,
																	 family = poisson,
																	 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																	 )
```

```{r Early Season Danaus GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.danaus.early.5.cities.DHARMa <- simulateResiduals(
	pop.danaus.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Danaus Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.danaus.early.5.cities, type = "II")),
			booktabs = TRUE,
			digits = 3, 
			caption = "Summary of the early season Danaus model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Danaus Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Calculate main effect comparison for city
pop.danaus.early.5.cities.emm_city <- emmeans(
	pop.danaus.early.5.cities, "City"
	)
```

```{r Early Season Danaus Analyses-5 Cities Post Hoc Comparisons (City), echo = FALSE}
kable(tidy(pop.danaus.early.5.cities.emm_city),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the main effect of city for Danaus for the late season 5 Cities.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Danaus 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Danaus abundance by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Danaus by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Monarchs",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Danaus, Early 5 Cities")
```

\newpage
### Late Season Danaus, Toronto

```{r Late Season Danaus GLMM-Toronto, include = FALSE}
# Fit the model
pop.danaus.late.toronto <- glmmTMB(Monarchs ~ Distance + (1 | Pop),
																	 data = late.toronto,
																	 ziformula = ~1,
																	 family = poisson
																	 )
```

```{r Late Season Danaus GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.danaus.late.toronto.DHARMa <- simulateResiduals(
	pop.danaus.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Danaus Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.danaus.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Danaus model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Danaus Toronto Plot, echo = FALSE, fig.cap = "Plot of Danaus abundance against distance from city center for the late season in Toronto."}
## Plot of Danaus by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Monarchs)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Danaus, Late Toronto") +
	theme_pubr()
```

\newpage
### Late Season Danaus, 5 Cities

```{r Late Season Danaus GLMM-5 Cities, include = FALSE}
# Fit the model
pop.danaus.late.5.cities <- glmer(Monarchs ~ Habitat + City + Habitat:City + (1 | Pop),
																	data = late.5.cities,
																	family = poisson,
																	glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																	)
```

```{r Late Season Danaus GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.danaus.late.5.cities.DHARMa <- simulateResiduals(
	pop.danaus.late.5.cities, n = 500, plot = TRUE
	)
```

```{r Late Season Danaus Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.danaus.late.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Danaus model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Danaus 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Danaus abundance by habitat and city for the late season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Danaus by habitat and city in the late season for the 5 Cities
ggerrorplot(
	data = late.5.cities,
	x = "Habitat", y = "Monarchs",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Danaus, Late 5 Cities")
```


\newpage
## Rhysomatus

### Early Season Rhysomatus, Toronto

```{r Early Season Rhysomatus GLMM-Toronto, include = FALSE}
# Fit the model
pop.rhysomatus.early.toronto <- glmmTMB(Rhysomatus ~ Distance + (1 | Pop),
																				data = early.toronto,
																				ziformula = ~1,
																				family = poisson
																				)
```

```{r Early Season Rhysomatus GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.rhysomatus.early.toronto.DHARMa <- simulateResiduals(
	pop.rhysomatus.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Rhysomatus Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.rhysomatus.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Rhysomatus model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Rhysomatus Toronto Plot, echo = FALSE, fig.cap = "Plot of Rhysomatus abundance against distance from city center for the early season in Toronto."}
## Plot of Rhysomatus by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Rhysomatus)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Rhysomatus, Early Toronto") +
	theme_pubr()
```

\newpage
### Early Season Rhysomatus, 5 Cities

```{r Early Season Rhysomatus GLMM-5 Cities, include = FALSE}
# Fit the model
pop.rhysomatus.early.5.cities <- glmer(Rhysomatus ~ Habitat + City + Habitat:City + (1 | Pop),
																			 data = early.5.cities,
																			 family = poisson,
																			 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																			 )
```

```{r Early Season Rhysomatus GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.rhysomatus.early.5.cities.DHARMa <- simulateResiduals(
	pop.rhysomatus.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Rhysomatus Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.rhysomatus.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Rhysomatus model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Rhysomatus 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Rhysomatus abundance by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Rhysomatus by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Rhysomatus",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Rhysomatus, Early 5 Cities")
```

\newpage
### Late Season Rhysomatus, Toronto

```{r Late Season Rhysomatus GLMM-Toronto, include = FALSE}
# Fit the model
pop.rhysomatus.late.toronto <- glmmTMB(Rhysomatus ~ Distance + (1 | Pop),
																			 data = late.toronto, 
																			 ziformula = ~1,
																			 family = poisson
																			 )
```

```{r Late Season Rhysomatus GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.rhysomatus.late.toronto.DHARMa <- simulateResiduals(
	pop.rhysomatus.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Rhysomatus Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.rhysomatus.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Rhysomatus model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Rhysomatus Toronto Plot, echo = FALSE, fig.cap = "Plot of Rhysomatus abundance against distance from city center for the late season in Toronto."}
## Plot of Rhysomatus by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Rhysomatus)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Rhysomatus, Late Toronto") +
	theme_pubr()
```


### Late Season Rhysomatus, 5 Cities

Insufficient *Rhysomatus* were collected to fit a model.


\newpage
## Aphis

### Early Season Aphis, Toronto

```{r Early Season Aphis GLMM-Toronto, include = FALSE}
# Fit the model
pop.aphis.early.toronto <- glmmTMB(Green_aphid ~ Distance + (1 | Pop),
																	 data = early.toronto,
																	 ziformula = ~1,
																	 family = poisson
																	 )
```

```{r Early Season Aphis GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.aphis.early.toronto.DHARMa <- simulateResiduals(
	pop.aphis.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Aphis Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.aphis.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Aphis model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Aphis Toronto Plot, echo = FALSE, fig.cap = "Plot of Aphis abundance against distance from city center for the early season in Toronto."}
## Plot of Aphis by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Green_aphid)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Aphis, Early Toronto") +
	theme_pubr()
```


### Early Season Aphis, 5 Cities

Insufficient *Aphis* were collected to fit a model.

\newpage
### Late Season Aphis, Toronto

```{r Late Season Aphis GLMM-Toronto, include = FALSE}
# Fit the model
pop.aphis.late.toronto <- glmmTMB(Green_aphid ~ Distance + (1 | Pop),
																	data = late.toronto,
																	ziformula = ~1,
																	family = poisson
																	)
```

```{r Late Season Aphis GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.aphis.late.toronto.DHARMa <- simulateResiduals(
	pop.aphis.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Aphis Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.aphis.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Aphis model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Aphis Toronto Plot, echo = FALSE, fig.cap = "Plot of Aphis abundance against distance from city center for the late season in Toronto."}
## Plot of Aphis by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Green_aphid)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Aphis, Late Toronto") +
	theme_pubr()
```


### Late Season Aphis, 5 Cities

Insufficient *Aphis* were collected to fit a model.


\newpage
## Tetraopes

### Early Season Tetraopes, Toronto

```{r Early Season Tetraopes GLMM-Toronto, include = FALSE}
# Fit the model
pop.tetraopes.early.toronto <- glmmTMB(Tetraopes ~ Distance + (1 | Pop),
																			 data = early.toronto,
																			 ziformula = ~1,
																			 family = poisson
																			 )
```

```{r Early Season Tetraopes GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.tetraopes.early.toronto.DHARMa <- simulateResiduals(
	pop.tetraopes.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Tetraopes Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.tetraopes.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Tetraopes model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Tetraopes Toronto Plot, echo = FALSE, fig.cap = "Plot of Tetraopes abundance against distance from city center for the early season in Toronto."}
## Plot of Tetraopes by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Tetraopes)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Tetraopes, Early Toronto") +
	theme_pubr()
```

\newpage
### Early Season Tetraopes, 5 Cities

```{r Early Season Tetraopes GLMM-5 Cities, include = FALSE}
# Fit the model
pop.tetraopes.early.5.cities <- glmer(Tetraopes ~ Habitat + City + Habitat:City + (1 | Pop),
																			data = early.5.cities,
																			family = poisson,
																			glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																			)
```

```{r Early Season Tetraopes GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.tetraopes.early.5.cities.DHARMa <- simulateResiduals(
	pop.tetraopes.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Tetraopes Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.tetraopes.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Tetraopes model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Tetraopes 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Tetraopes abundance by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Tetraopes by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Tetraopes",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Tetraopes, Early 5 Cities")
```

\newpage
### Late Season Tetraopes, Toronto

```{r Late Season Tetraopes GLMM-Toronto, include = FALSE}
# Fit the model
pop.tetraopes.late.toronto <- glmmTMB(Tetraopes ~ Distance + (1 | Pop),
																			data = late.toronto,
																			ziformula = ~1,
																			family = poisson
																			)
```

```{r Late Season Tetraopes GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.tetraopes.late.toronto.DHARMa <- simulateResiduals(
	pop.tetraopes.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Tetraopes Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.tetraopes.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Tetraopes model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Tetraopes Toronto Plot, echo = FALSE, fig.cap = "Plot of Tetraopes abundance against distance from city center for the late season in Toronto."}
## Plot of Tetraopes by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Tetraopes)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Tetraopes, Late Toronto") +
	theme_pubr()
```


### Late Season Tetraopes, 5 Cities

Insufficient *Tetraopes* were collected to fit a model.


\newpage
## Liriomyza

### Early Season Liriomyza, Toronto

```{r Early Season Liriomyza GLMM-Toronto, include = FALSE}
# Fit the model
pop.liriomyza.early.toronto <- glmmTMB(Fly ~ Distance + (1 | Pop),
																			 data = early.toronto,
																			 ziformula = ~1,
																			 family = poisson
																			 )
```

```{r Early Season Liriomyza GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.liriomyza.early.toronto.DHARMa <- simulateResiduals(
	pop.liriomyza.early.toronto, n = 500, plot = TRUE
	)
```

```{r Early Season Liriomyza Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.liriomyza.early.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Liriomyza model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Liriomyza Toronto Plot, echo = FALSE, fig.cap = "Plot of Liriomyza abundance against distance from city center for the early season in Toronto."}
## Plot of Liriomyza by distance in the early season for Toronto
ggplot(
	data = early.toronto,
	aes(x = Distance, y = Fly)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Liriomyza, Early Toronto") +
	theme_pubr()
```

\newpage
### Early Season Liriomyza, 5 Cities

```{r Early Season Liriomyza GLMM-5 Cities, include = FALSE}
# Fit the model
pop.liriomyza.early.5.cities <- glmer(Fly ~ Habitat + City + Habitat:City + (1 | Pop),
																			data = early.5.cities,
																			family = poisson,
																			glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																			)
```

```{r Early Season Liriomyza GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.liriomyza.early.5.cities.DHARMa <- simulateResiduals(
	pop.liriomyza.early.5.cities, n = 500, plot = TRUE
	)
```

```{r Early Season Liriomyza Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.liriomyza.early.5.cities, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the early season Liriomyza model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Early Season Liriomyza 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Liriomyza abundance by habitat and city for the early season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Liriomyza by habitat and city in the early season for the 5 Cities
ggerrorplot(
	data = early.5.cities,
	x = "Habitat", y = "Fly",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Liriomyza, Early 5 Cities")
```

\newpage
### Late Season Liriomyza, Toronto

```{r Late Season Liriomyza GLMM-Toronto, include = FALSE}
# Fit the model
pop.liriomyza.late.toronto <- glmmTMB(Fly ~ Distance + (1 | Pop),
																			data = late.toronto,
																			ziformula = ~1,
																			family = poisson
																			)
```

```{r Late Season Liriomyza GLMM-Toronto-Diagnostic Plots, include = FALSE}
## Check model fit
pop.liriomyza.late.toronto.DHARMa <- simulateResiduals(
	pop.liriomyza.late.toronto, n = 500, plot = TRUE
	)
```

```{r Late Season Liriomyza Analyses-Toronto ANOVA, echo = FALSE}
kable(tidy(Anova(pop.liriomyza.late.toronto, type = "II")),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Summary of the late season Liriomyza model for Toronto with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Liriomyza Toronto Plot, echo = FALSE, fig.cap = "Plot of Liriomyza abundance against distance from city center for the late season in Toronto."}
## Plot of Liriomyza by distance in the late season for Toronto
ggplot(
	data = late.toronto,
	aes(x = Distance, y = Fly)) + 
	geom_point(colour = "#E69512") + 
	geom_smooth(method = "glm", formula = y ~ x, se = TRUE,
							method.args = list(family = "quasipoisson"),
							colour = "#637EAA", fill = "#637EAA") +
	labs(x = "Distance from City Center", y = "Abundance") +
	ggtitle("Liriomyza, Late Toronto") +
	theme_pubr()
```

\newpage
### Late Season Liriomyza, 5 Cities

```{r Late Season Liriomyza GLMM-5 Cities, include = FALSE}
# Fit the model
pop.liriomyza.late.5.cities <- glmer(Fly ~ Habitat + City + Habitat:City + (1 | Pop),
																		 data = late.5.cities,
																		 family = poisson,
																		 glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))
																		 )
```

```{r Late Season Liriomyza GLMM-5 Cities-Diagnostic Plots, include = FALSE}
## Check model fit
pop.liriomyza.late.5.cities.DHARMa <- simulateResiduals(
	pop.liriomyza.late.5.cities, n = 500, plot = TRUE
	)
```

```{r Late Season Liriomyza Analyses-5 Cities ANOVA, echo = FALSE}
kable(tidy(Anova(pop.liriomyza.late.5.cities, type = "II")),
			booktabs = TRUE,
			digits = 3, 
			caption = "Summary of the late season Liriomyza model for the 5 Cities with Type II sums-of-squares.",
			col.names = c("Term",
										"chi-squared",
										"df",
										"P-value")) %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Liriomyza Analyses-5 Cities Post Hoc Calculations, include = FALSE}
## Calculate main effect comparison for habitat
pop.liriomyza.late.5.cities.emm_habitat <- emmeans(
	pop.liriomyza.late.5.cities, "Habitat"
	)

## Initial check of the interaction term
pop.liriomyza.late.5.cities.emm_check <- emmip(
	pop.liriomyza.late.5.cities, 
	City ~ Habitat
	)
pop.liriomyza.late.5.cities.emm_check # Interaction is valid

## Calculate pairwise comparisons
pop.liriomyza.late.5.cities.emm <- emmeans(
	pop.liriomyza.late.5.cities,
	pairwise ~ City | Habitat)
```

```{r Late Season Liriomyza Analyses-5 Cities Post Hoc Comparisons (Habitat), echo = FALSE}
kable(tidy(pop.liriomyza.late.5.cities.emm_habitat),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the main effect of habitat for Liriomyza for the early season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Liriomyza Analyses-5 Cities Post Hoc Comparisons, echo = FALSE}
kable(tidy(pop.liriomyza.late.5.cities.emm$contrasts),
			booktabs = TRUE, 
			digits = 3, 
			caption = "Post-hoc comparisons of the interaction between city and habitat for Liriomyzay for the late season 5 Cities, where 1 = Rural and 2 = Urban.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped"))
```

```{r Late Season Liriomyza 5 Cities Plot, echo = FALSE, fig.cap = "Plot of Liriomyza abundance by habitat and city for the late season across the 5 Cities. Lines connect urban and rural habitats for each city."}
## Plot of Liriomyza by habitat and city in the late season for the 5 Cities
ggerrorplot(
	data = late.5.cities,
	x = "Habitat", y = "Fly",
	size = 2, width = 2,
	desc_stat = "mean_se",
	color = "City",
	palette = cal_palette(name = "superbloom3", n = 5, type = "continuous"),
	xlab = "Habitat",
	ylab = "Abundance",
	position = position_dodge(0.65),
	ggtheme = theme_pubr()) %>%
	facet(
		facet.by = "City",
		nrow = 1,
		ncol = 5
	) +
	stat_summary(aes(group = City), fun = mean, geom = "path", 
							 color = superbloom.10.lines) +
	scale_x_discrete(labels = c("1" = "Urban", "2" = "Rural"),
									 limits = c("1", "2")) + 
	ggtitle("Liriomyza, Late 5 Cities")
```




\newpage
# Piecewise Structural Equation Modelling

Piecewise SEM is a flexible form of confirmatory path analysis that allows for non-normal distributions, hierarchical data structures, and correlated data (Lefcheck, 2015). In contrast to traditional SEM that assesses the variance-covariance of the entire model structure (i.e., global estimation; Grace, 2006), pSEM separately evaluates each model in the structural equation set (i.e., local estimation; Lefcheck, 2015). We fitted pSEMs to test for (1) effects of urbanization, (2) effects of herbivore species interactions, and (3) the combined effects of urbanization and species interactions within and between seasons during the sampling periods. Species were pruned from the focal list if that species did not (1) comprise at least 5% relative abundance of the total insect abundance and (2) occur in at least 5% of the populations.


For more information on pSEM and SEM:

> Lefcheck, J. S. 2015, piecewiseSEM: Piecewise structural equation modelling in R for ecology, evolution, and systematics. _Methods in Ecology & Evolution_ 7: 573-579.

> Grace, J. B. 2006. Structural Equation Modeling and Natural Systems. _Cambridge University Press_.

> Grace, J. B., et al. 2010. On the specification of structural equation models for ecological systems. _Ecological Monographs_ 80: 67-87.


## Pathway Matrix

|            | Danaus     | Rhysomatus | Aphis      | Tetraopes  | Liriomyza  |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
| Danaus     | 1          | 0          | 1          | 1          | 1          |
| Rhysomatus | 1          | 1          | 1          | 1          | 1          |
| Aphis      | 1          | 0          | 1          | 1          | 1          |
| Tetraopes  | 1          | 0          | 1          | 1          | 1          |
| Liriomyza  | 1          | 0          | 1          | 1          | 1          |

Table: Matrix of causal pathways from early (columns) to late (rows) taxa, with 1 indicating a causal pathway between the two taxa from early to late period. Correlations within trial periods will be fitted for herbivores as a measure of potential competition or antagonism.

```{r pSEM Site Info, include = FALSE}
## Extract site info from the raw data
site.info <- raw.SEM.data %>%
  select(Population_ID, Pop, City, Trial, Lat, Long, Distance) %>%
  unique()
```


```{r pSEM Abundance Data Management, include = FALSE}
## Sum herbivore abundances from all 5 plants by trial + population
# Danaus
danaus.abundances <- aggregate(
	Danaus ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)

# Rhysomatus
rhysomatus.abundances <- aggregate(
	Rhysomatus ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)

# Aphis
aphis.abundances <- aggregate(
	Aphis_nerii ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)

# Myzocallis
myzocallis.abundances <- aggregate(
	Myzocallis ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)

# Tetraopes
tetraopes.abundances <- aggregate(
	Tetraopes ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)

# Liriomyza
liriomyza.abundances <- aggregate(
	Liriomyza ~ Trial + Population_ID,
  data = raw.SEM.data, FUN = sum
)


## Bind herbivore abundances together
herbivore.abundances <- danaus.abundances %>%
  left_join(rhysomatus.abundances) %>%
  left_join(aphis.abundances) %>%
  left_join(myzocallis.abundances) %>%
  left_join(tetraopes.abundances) %>%
  left_join(liriomyza.abundances)

## Merge site info with abundance data
abundance.data <- site.info %>%
  full_join(herbivore.abundances)

## Subset early data
early.abundances <- abundance.data %>%
  filter(Trial == "Early") %>%
  rename(
    Danaus.early = Danaus, Rhysomatus.early = Rhysomatus, Aphis.early = Aphis_nerii,
    Myzocallis.early = Myzocallis, Tetraopes.early = Tetraopes, Liriomyza.early = Liriomyza
  )

## Remove trial column
early.abundances <- early.abundances[, -4]

## Subset late data
late.abundances <- abundance.data %>%
  filter(Trial == "Late") %>%
  rename(
    Danaus.late = Danaus, Rhysomatus.late = Rhysomatus, Aphis.late = Aphis_nerii,
    Myzocallis.late = Myzocallis, Tetraopes.late = Tetraopes, Liriomyza.late = Liriomyza
  )

## Remove trial column
late.abundances <- late.abundances[, -4]

## Merge early and late info final abundance dataframe
final.abundance.data <- early.abundances %>%
  left_join(late.abundances) %>%
  na.omit()
```


```{r pSEM Presence-Absence Data Management, include = FALSE}
## Convert abundance matrices to presence-absence matrices
# Danaus
danaus.presabs <- danaus.abundances[, 3]
danaus.presabs[danaus.presabs > 0] <- 1
danaus.presabs.binary <- cbind(site.info, danaus.presabs)

# Rhysomatus
rhysomatus.presabs <- rhysomatus.abundances[, 3]
rhysomatus.presabs[rhysomatus.presabs > 0] <- 1
rhysomatus.presabs.binary <- cbind(site.info, rhysomatus.presabs)

# Aphis
aphis.presabs <- aphis.abundances[, 3]
aphis.presabs[aphis.presabs > 0] <- 1
aphis.presabs.binary <- cbind(site.info, aphis.presabs)

# Myzocallis
myzocallis.presabs <- myzocallis.abundances[, 3]
myzocallis.presabs[myzocallis.presabs > 0] <- 1
myzocallis.presabs.binary <- cbind(site.info, myzocallis.presabs)

# Tetraopes
tetraopes.presabs <- tetraopes.abundances[, 3]
tetraopes.presabs[tetraopes.presabs > 0] <- 1
tetraopes.presabs.binary <- cbind(site.info, tetraopes.presabs)

# Liriomyza
liriomyza.presabs <- liriomyza.abundances[, 3]
liriomyza.presabs[liriomyza.presabs > 0] <- 1
liriomyza.presabs.binary <- cbind(site.info, liriomyza.presabs)


## Bind herbivore presence-absence together
herbivore.presabs <- danaus.presabs.binary %>%
  left_join(rhysomatus.presabs.binary) %>%
  left_join(aphis.presabs.binary) %>%
  left_join(myzocallis.presabs.binary) %>%
  left_join(tetraopes.presabs.binary) %>%
  left_join(liriomyza.presabs.binary)

## Merge site info with presence-absence data
presence.absence.data <- site.info %>%
  full_join(herbivore.presabs)

## Subset early data
early.presence.absence <- presence.absence.data %>%
  filter(Trial == "Early") %>%
  rename(
    Danaus.early = danaus.presabs, Rhysomatus.early = rhysomatus.presabs,
    Aphis.early = aphis.presabs, Myzocallis.early = myzocallis.presabs,
    Tetraopes.early = tetraopes.presabs, Liriomyza.early = liriomyza.presabs
  )

## Remove trial column
early.presence.absence <- early.presence.absence[, -4]

## Subset late data
late.presence.absence <- presence.absence.data %>%
  filter(Trial == "Late") %>%
  rename(
    Danaus.late = danaus.presabs, Rhysomatus.late = rhysomatus.presabs,
    Aphis.late = aphis.presabs, Myzocallis.late = myzocallis.presabs,
    Tetraopes.late = tetraopes.presabs, Liriomyza.late = liriomyza.presabs
  )

## Remove trial column
late.presence.absence <- late.presence.absence[, -4]

## Merge early and late info final presence-absence dataframe
final.presence.absence.data <- early.presence.absence %>%
  left_join(late.presence.absence) %>%
  na.omit()
```

\newpage
## Urbanization pSEM

```{r Toronto Urban pSEM Specification, include = FALSE}
urb.pSEM.toronto <- psem(
  ## Danaus
  danaus.presence.absence.early.urb_herb.toronto <- glm(
  	Danaus.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  danaus.presence.absence.late.urb_herb.toronto <- glm(
  	Danaus.late ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  

  ## Rhysomatus
  rhysomatus.presence.absence.early.urb_herb.toronto <- glm(
  	Rhysomatus.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  rhysomatus.presence.absence.late.toronto <- glm(
  	Rhysomatus.late ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),

  
  ## Aphis
  aphis.presence.absence.early.urb_herb.toronto <- glm(
  	Aphis.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  aphis.presence.absence.late.urb_herb.toronto <- glm(
  	Aphis.late ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),


  ## Tetraopes
  tetraopes.presence.absence.early.urb_herb.toronto <- glm(
  	Tetraopes.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  tetraopes.presence.absence.late.urb_herb.toronto <- glm(
  	Tetraopes.late ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),

  
  ## Liriomyza
  liriomyza.presence.absence.early.urb_herb.toronto <- glm(
  	Liriomyza.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  liriomyza.presence.absence.late.urb_herb.toronto <- glm(
  	Liriomyza.late ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit"),
  )
)
```

```{r Toronto Urban pSEM Summary, include = FALSE}
## pSEM summary
summary(urb.pSEM.toronto, conserve = TRUE)

## Test of directed separation
dSep(urb.pSEM.toronto, conserve = TRUE)

## Get Fisher's C statistics of model fit
fisherC(urb.pSEM.toronto, conserve = TRUE)

## R-squared values for endogenous variables
urb.pSEM.rsquared <- rsquared(urb.pSEM.toronto)

## Standardized coefficients for binomial response
urb.pSEM.path.coefficients <- coefs(urb.pSEM.toronto, standardize.type = "latent.linear")
```

```{r Toronto Urban pSEM Path Coefficients, echo = FALSE}
kable(urb.pSEM.path.coefficients, 
			booktabs = TRUE, 
			digits = 3, 
			caption = "Path coefficients for each causal and correlational pathway in the herbivore pSEM for the Toronto dataset. Global model fit: Fisher's $C = 79.403, df = 90, P = 0.780$; AIC $= 119.403$. $R^2$ values for endogenous variables: $Danaus_{early} = 0.01, Danaus_{late} = 0.04, Rhysomatus_{early} = 0.10, Rhysomatus_{late} = 0.01, Aphis_{early} = 0.21, Aphis_{late} = 0.08, Tetraopes_{early} < 0.01, Tetraopes_{late} < 0.01, Liriomyza_{early} = 0.04, Liriomyza_{late} = 0.09$.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped", "scale_down"))
```


\newpage
## Herbivore pSEM

```{r Toronto Herbivore pSEM Specification, include = FALSE}
herb.pSEM.toronto <- psem(
  ## Danaus
  danaus.presence.absence.late.herb.toronto <- glm(
  	Danaus.late ~ Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Danaus.early %~~% Rhysomatus.early,
  Danaus.early %~~% Aphis.early,
	Danaus.early %~~% Tetraopes.early,
  Danaus.early %~~% Liriomyza.early,
  Danaus.late %~~% Rhysomatus.late,
  Danaus.late %~~% Aphis.late,
	Danaus.late %~~% Tetraopes.late,
	Danaus.late %~~% Liriomyza.late,

  
  ## Rhysomatus
  rhysomatus.presence.absence.late.herb.toronto <- glm(
  	Rhysomatus.late ~ Rhysomatus.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Rhysomatus.early %~~% Liriomyza.early,
  Rhysomatus.late %~~% Liriomyza.late,

  
  ## Aphis
  aphis.presence.absence.late.herb.toronto <- glm(
  	Aphis.late ~ Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Aphis.early %~~% Rhysomatus.early,
  Aphis.early %~~% Tetraopes.early,
  Aphis.early %~~% Liriomyza.early,
  Aphis.late %~~% Rhysomatus.late,
  Aphis.late %~~% Tetraopes.late,
	Aphis.late %~~% Liriomyza.late,


  ## Tetraopes
  tetraopes.presence.absence.late.herb.toronto <- glm(
  	Tetraopes.late ~ Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Tetraopes.early %~~% Rhysomatus.early,
  Tetraopes.early %~~% Liriomyza.early,
  Tetraopes.late %~~% Rhysomatus.late,
	Tetraopes.late %~~% Liriomyza.late,
  
  
  ## Liriomyza
  liriomyza.presence.absence.late.herb.toronto <- glm(
  	Liriomyza.late ~ Danaus.early + Rhysomatus.early + Aphis.early + Liriomyza.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit"),
  )
)
```

```{r Toronto Herbivore pSEM Summary, include = FALSE}
## pSEM summary
summary(herb.pSEM.toronto)

## Test of directed separation
dSep(herb.pSEM.toronto)

## Get Fisher's C statistics of model fit
fisherC(herb.pSEM.toronto)

## R-squared values for endogenous variables
herb.pSEM.rsquared <- rsquared(herb.pSEM.toronto)

## Standardized coefficients for binomial response
herb.pSEM.path.coefficients <- coefs(herb.pSEM.toronto, standardize.type = "latent.linear")
```

```{r Toronto Herbivore pSEM Path Coefficients, echo = FALSE}
kable(herb.pSEM.path.coefficients, 
			booktabs = TRUE, 
			digits = 3, 
			caption = "Path coefficients for each causal and correlational pathway in the herbivore pSEM for the Toronto dataset. Global model fit: Fisher's $C = 1.404, df = 10, P = 0.999$; AIC $= 51.404$. $R^2$ values for endogenous variables: $Danaus_{late} = 0.22, Rhysomatus_{late} = 0.02, Aphis_{late} = 0.17, Tetraopes_{late} = 0.17, Liriomyza_{late} = 0.12$.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped", "scale_down"))
```


\newpage
## Urbanization + Herbivore pSEM

```{r Toronto Urban + Herbivore pSEM Specification, include = FALSE}
urb_herb.pSEM.toronto <- psem(
  ## Danaus
  danaus.presence.absence.early.urb_herb.toronto <- glm(
  	Danaus.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  danaus.presence.absence.late.urb_herb.toronto <- glm(
  	Danaus.late ~ Distance + Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Danaus.early %~~% Rhysomatus.early,
  Danaus.early %~~% Aphis.early,
	Danaus.early %~~% Tetraopes.early,
  Danaus.early %~~% Liriomyza.early,
  Danaus.late %~~% Rhysomatus.late,
  Danaus.late %~~% Aphis.late,
	Danaus.late %~~% Tetraopes.late,
	Danaus.late %~~% Liriomyza.late,

  
  ## Rhysomatus
  rhysomatus.presence.absence.early.urb_herb.toronto <- glm(
  	Rhysomatus.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  rhysomatus.presence.absence.late.urb_herb.toronto <- glm(
  	Rhysomatus.late ~ Distance + Rhysomatus.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Rhysomatus.early %~~% Liriomyza.early,
  Rhysomatus.late %~~% Liriomyza.late,

  
  ## Aphis
  aphis.presence.absence.early.urb_herb.toronto <- glm(
  	Aphis.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  aphis.presence.absence.late.urb_herb.toronto <- glm(
  	Aphis.late ~ Distance + Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Aphis.early %~~% Rhysomatus.early,
  Aphis.early %~~% Tetraopes.early,
  Aphis.early %~~% Liriomyza.early,
  Aphis.late %~~% Rhysomatus.late,
  Aphis.late %~~% Tetraopes.late,
	Aphis.late %~~% Liriomyza.late,


  ## Tetraopes
  tetraopes.presence.absence.early.urb_herb.toronto <- glm(
  	Tetraopes.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  tetraopes.presence.absence.late.urb_herb.toronto <- glm(
  	Tetraopes.late ~ Distance + Danaus.early + Rhysomatus.early + Aphis.early + Tetraopes.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  
  ## Correlations
  Tetraopes.early %~~% Rhysomatus.early,
  Tetraopes.early %~~% Liriomyza.early,
  Tetraopes.late %~~% Rhysomatus.late,
	Tetraopes.late %~~% Liriomyza.late,
  
  
  ## Liriomyza
  liriomyza.presence.absence.early.urb_herb.toronto <- glm(
  	Liriomyza.early ~ Distance,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit")
  ),
  liriomyza.presence.absence.late.urb_herb.toronto <- glm(
  	Liriomyza.late ~ Distance + Danaus.early + Rhysomatus.early + Aphis.early + Liriomyza.early + Liriomyza.early,
    data = final.presence.absence.data[final.presence.absence.data$City == "Toronto", ],
    family = binomial(link = "logit"),
  )
)
```

```{r Toronto Urban + Herbivore pSEM Summary, include = FALSE}
## pSEM summary
summary(urb_herb.pSEM.toronto)

## Test of directed separation
dSep(urb_herb.pSEM.toronto)

## Get Fisher's C statistics of model fit
fisherC(urb_herb.pSEM.toronto)

## R-squared values for endogenous variables
urb_herb.pSEM.rsquared <- rsquared(urb_herb.pSEM.toronto)

## Standardized coefficients for binomial response
urb_herb.pSEM.path.coefficients <- coefs(urb_herb.pSEM.toronto, standardize.type = "latent.linear")
```

```{r Toronto Urban + Herbivore pSEM Path Coefficients, echo = FALSE}
kable(urb_herb.pSEM.path.coefficients, 
			booktabs = TRUE, 
			digits = 3, 
			caption = "Path coefficients for each causal and correlational pathway in the herbivore pSEM for the Toronto dataset. Global model fit: Fisher's $C = 2.218, df = 10, P = 0.994$; AIC $= 82.218$. $R^2$ values for endogenous variables: $Danaus_{early} = 0.01, Danaus_{late} = 0.22, Rhysomatus_{early} = 0.10, Rhysomatus_{late} = 0.03, Aphis_{early} = 0.21, Aphis_{late} = 0.19, Tetraopes_{early} < 0.01, Tetraopes_{late} = 0.19, Liriomyza_{early} = 0.04, Liriomyza_{late} = 0.21$.") %>%
	kable_styling(latex_options = c("HOLD_position", "striped", "scale_down"))
```



\newpage
## Toronto Urban pSEM Takeaways


| Pathway                     | Standardized Estimate | P-value |
|:----------------------------|:--------:|:--------:|
| $Rhysomatus_{early}$ ~ $Distance$           |  0.38 | 0.098 |
| $Aphis_{early}$ ~ $Distance$                | -0.72 | 0.060 |
| $Aphis_{late}$ ~ $Distance$                 | -0.36 | 0.097 |
| $Liriomyza_{late}$ ~ $Distance$             | -0.32 | 0.062 |

Table: Below are the ecologically relevant causal pathways from the urbanization pSEM. Note: the herbivore pSEM had better model fit.


## Toronto Herbivore pSEM Takeaways


| Pathway                     | Standardized Estimate | P-value |
|:----------------------------|:--------:|:--------:|
| $Danaus_{early}$ ~~ $Liriomyza_{early}$      |  0.21 | 0.098 |
| $Danaus_{late}$ ~~ $Aphis_{late}$           |  0.21 | 0.048 |
| $Danaus_{late}$ ~~ $Tetraopes_{late}$       | -0.21 | 0.044 |
| $Aphis_{late}$  ~ $Aphis_{early}$           |  0.11 | 0.072 |
| $Aphis_{late}$ ~~ $Tetraopes_{late}$        |  0.29 | 0.010 |
| $Tetraopes_{early}$ ~~ $Rhysomatus_{early}$ |  0.26 | 0.039 |
| $Tetraopes_{late}$ ~~ $Rhysomatus_{late}$   |  0.20 | 0.056 |

Table: Below are the ecologically relevant causal and correlational pathways from the herbivore pSEM.


## Toronto Urban + Herbivore pSEM Takeaways


| Pathway                     | Standardized Estimate | P-value |
|:----------------------------|:--------:|:--------:|
| $Danaus_{early}$ ~~ $Aphis_{early}$         |  0.21 | 0.050 |
| $Danaus_{early}$ ~~ $Liriomyza_{early}$     |  0.22 | 0.039 |
| $Danaus_{late}$ ~~ $Aphis_{late}$           |  0.20 | 0.054 |
| $Danaus_{late}$ ~~ $Tetraopes_{late}$       | -0.22 | 0.040 |
| $Rhysomatus_{early}$ ~ $Distance$           |  0.38 | 0.098 |
| $Aphis_{early}$ ~ $Distance$                | -0.72 | 0.060 |
| $Aphis_{late}$ ~~ $Tetraopes_{late}$        |  0.28 | 0.012 |
| $Tetraopes_{early}$ ~~ $Rhysomatus_{early}$ |  0.24 | 0.025 |
| $Tetraopes_{late}$ ~~ $Rhysomatus_{late}$   |  0.20 | 0.055 |
| $Liriomyza_{late}$ ~ $Distance$             | -0.13 | 0.057 |
| $Liriomyza_{late}$ ~ $Liriomyza_{early}$    |  0.13 | 0.064 |

Table: Below are the ecologically relevant causal and correlational pathways from the urbanization + herbivore pSEM. Note: the herbivore pSEM had better model fit.


```{r Save Final Workspace, include = FALSE}
save.image("R/1-Primary_Analyses/ON_herb-analyses-final_workspace.RData")
```

